@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Rendering
@using Microsoft.AspNetCore.Components.Routing
@using AuthManagement.Services
@inject PageAccessService PageAccessService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

@if (IsCheckingAccess)
{
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-3">Checking access...</div>
    </div>
}
else if (!HasAccess)
{
    @* Fallback - typically we redirect before reaching here *@
    <div class="container-xxl flex-grow-1 container-p-y">
        <div class="misc-wrapper text-center">
            <h2 class="mb-1 mx-2">Access Denied</h2>
            <p class="mb-4 mx-2">You don't have permission to access this page.</p>
            <a href="/dashboard" class="btn btn-primary mb-4">Back to Dashboard</a>
        </div>
    </div>
}
else
{
    <AuthorizeRouteView RouteData="RouteData" DefaultLayout="DefaultLayout">
        <NotAuthorized>
            <RedirectToLogin />
        </NotAuthorized>
        <Authorizing>
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-3">Authorizing...</div>
            </div>
        </Authorizing>
    </AuthorizeRouteView>
}

@code {
    [Parameter]
    public RouteData RouteData { get; set; } = default!;

    [Parameter]
    public Type? DefaultLayout { get; set; }

    private bool IsCheckingAccess { get; set; } = true;
    private bool HasAccess { get; set; } = false;

    protected override async Task OnParametersSetAsync()
    {
        await CheckPageAccessAsync();
        await base.OnParametersSetAsync();
    }

    private async Task CheckPageAccessAsync()
    {
        IsCheckingAccess = true;
        HasAccess = false;

        // Get current URL
        var currentUrl = new Uri(NavigationManager.Uri).LocalPath;

        // Check page access
        var result = await PageAccessService.HasAccessToPageAsync(currentUrl);

        if (!result.HasAccess)
        {
            if (result.RequiresAuthentication)
            {
                // User not authenticated, redirect to login
                NavigationManager.NavigateTo("/login", true);
                return;
            }
            else
            {
                // User authenticated but no access, redirect to access denied
                NavigationManager.NavigateTo("/access-denied", true);
                return;
            }
        }

        HasAccess = true;
        IsCheckingAccess = false;
    }
}
