@using AuthManagement.Services
@inject ToastService ToastService
@implements IDisposable

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    @foreach (var toast in _toasts)
    {
        <div class="toast show border-0 shadow-lg mb-3 @GetToastClass(toast.Level)" role="alert" style="min-width: 350px; max-width: 450px; border-radius: 4px; overflow: hidden;">
            <div class="d-flex align-items-center p-3">
                <div class="toast-column me-3 d-flex align-items-center">
                    <i class="fa-solid @GetToastIcon(toast.Level) @GetIconColorClass(toast.Level)" style="font-size: 1.75rem;"></i>
                    <span class="ms-3" style="font-size: 1.07rem; font-weight: 500; color: #2c2c2c;">@toast.Message</span>
                </div>
                <i class="fa-solid fa-xmark ms-auto" @onclick="() => RemoveToast(toast.Id)" style="color: #aeb0d7; cursor: pointer; font-size: 1.2rem;"></i>
            </div>
            <div class="toast-progress @GetProgressClass(toast.Level)"></div>
        </div>
    }
</div>

@code {
    private List<ToastMessage> _toasts = new();

    protected override void OnInitialized()
    {
        ToastService.OnShow += ShowToast;
    }

    private void ShowToast(string message, ToastLevel level)
    {
        var toast = new ToastMessage
        {
            Id = Guid.NewGuid(),
            Message = message,
            Level = level
        };

        _toasts.Add(toast);
        StateHasChanged();

        _ = Task.Delay(5000).ContinueWith(_ =>
        {
            RemoveToast(toast.Id);
        });
    }

    private void RemoveToast(Guid id)
    {
        var toast = _toasts.FirstOrDefault(t => t.Id == id);
        if (toast != null)
        {
            _toasts.Remove(toast);
            InvokeAsync(StateHasChanged);
        }
    }

    private string GetToastClass(ToastLevel level)
    {
        return level switch
        {
            ToastLevel.Success => "toast-success",
            ToastLevel.Error => "toast-error",
            ToastLevel.Warning => "toast-warning",
            ToastLevel.Info => "toast-info",
            _ => "toast-info"
        };
    }

    private string GetToastIcon(ToastLevel level)
    {
        return level switch
        {
            ToastLevel.Success => "fa-circle-check",
            ToastLevel.Error => "fa-circle-xmark",
            ToastLevel.Warning => "fa-triangle-exclamation",
            ToastLevel.Info => "fa-circle-info",
            _ => "fa-circle-info"
        };
    }

    private string GetIconColorClass(ToastLevel level)
    {
        return level switch
        {
            ToastLevel.Success => "text-success-toast",
            ToastLevel.Error => "text-error-toast",
            ToastLevel.Warning => "text-warning-toast",
            ToastLevel.Info => "text-info-toast",
            _ => "text-info-toast"
        };
    }

    private string GetProgressClass(ToastLevel level)
    {
        return level switch
        {
            ToastLevel.Success => "progress-success",
            ToastLevel.Error => "progress-error",
            ToastLevel.Warning => "progress-warning",
            ToastLevel.Info => "progress-info",
            _ => "progress-info"
        };
    }

    public void Dispose()
    {
        ToastService.OnShow -= ShowToast;
    }

    private class ToastMessage
    {
        public Guid Id { get; set; }
        public string Message { get; set; } = string.Empty;
        public ToastLevel Level { get; set; }
    }
}
