@page "/login"
@using AuthManagement.Shared
@using AuthManagement.Models
@using AuthManagement.Services
@using System.Net.Http.Json
@using System
@using System.Diagnostics
@using System.Text.RegularExpressions
@inject HttpClient Http
@inject JwtAuthenticationStateProvider AuthProvider
@inject NavigationManager Nav
@inject ILogger<Login> Logger
@inject IJSRuntime JS
@inject NavigationService NavService
@layout AuthLayout
@implements IAsyncDisposable

<div class="authentication-wrapper authentication-basic container-p-y">
	@if (_isLoadingMenuAfterLogin)
	{
		<LoadingSpinner FullPage="true" />
	}
	<div class="authentication-inner py-6">
		<!-- Login -->
		<div class="card">
			<div class="card-body">
				<!-- Logo -->
				<div class="app-brand justify-content-center mb-6">
					<a href="/" class="app-brand-link">
						<span class="app-brand-logo demo">
							<span class="text-primary">
								<svg width="32" height="22" viewBox="0 0 32 22" fill="none" xmlns="http://www.w3.org/2000/svg">
									<path fill-rule="evenodd" clip-rule="evenodd" d="M0.00172773 0V6.85398C0.00172773 6.85398 -0.133178 9.01207 1.98092 10.8388L13.6912 21.9964L19.7809 21.9181L18.8042 9.88248L16.4951 7.17289L9.23799 0H0.00172773Z" fill="currentColor"></path>
									<path opacity="0.06" fill-rule="evenodd" clip-rule="evenodd" d="M7.69824 16.4364L12.5199 3.23696L16.5541 7.25596L7.69824 16.4364Z" fill="#161616"></path>
									<path opacity="0.06" fill-rule="evenodd" clip-rule="evenodd" d="M8.07751 15.9175L13.9419 4.63989L16.5849 7.28475L8.07751 15.9175Z" fill="#161616"></path>
									<path fill-rule="evenodd" clip-rule="evenodd" d="M7.77295 16.3566L23.6563 0H32V6.88383C32 6.88383 31.8262 9.17836 30.6591 10.4057L19.7824 22H13.6938L7.77295 16.3566Z" fill="currentColor"></path>
								</svg>
							</span>
						</span>
						<span class="app-brand-text demo text-heading fw-bold">Gishur</span>
					</a>
				</div>
				<!-- /Logo -->
				<h4 class="mb-1">Welcome Back! </h4>
				<p class="mb-6">Please sign-in to your account and start the adventure</p>

				<EditForm Model="loginModel" OnValidSubmit="HandleLogin" class="mb-4">
					<div class="mb-6 form-control-validation">
						<label for="email" class="form-label">Email <span class="text-danger">*</span></label>
						<input type="text" class="form-control" 
							   id="email" 
							   @bind="loginModel.Email"
							   placeholder="Enter your email" 
							   autofocus data-input-type="email">
					</div>
					<div class="mb-6 form-password-toggle form-control-validation">
						<label class="form-label" for="password">Password <span class="text-danger">*</span></label>
						<div class="input-group input-group-merge">
							<input type="password" id="password" class="form-control" @bind="loginModel.Password" placeholder="路路路路路路路路路路路路" aria-describedby="password">
							<span class="input-group-text cursor-pointer password-eye"><i class="icon-base ti tabler-eye-off"></i></span>
						</div>
					</div>

					<div class="my-4">
						<div class="d-flex justify-content-end">
							<a href="/forgot-password">
								<p class="mb-0">Forgot Password?</p>
							</a>
						</div>
					</div>
					<div class="mb-6">
						<button class="btn btn-primary d-flex w-100" type="submit" disabled="@isLoading">
							@if (isLoading)
							{
								<span class="spinner-border spinner-border-sm me-2" role="status"></span>
								<span>Logging in...</span>
							}
							else
							{
								<span>Login</span>
							}
						</button>
					</div>
				</EditForm>

				<p class="text-center">
					<span>New on our platform?</span>
					<a href="/register">
						<span>Create an account</span>
					</a>
				</p>
			</div>
		</div>
		<!-- /Login -->
	</div>
</div>

@code {

	private LoginModel loginModel = new();
	private string? message;
	private bool isLoading;
	private bool _isLoadingMenuAfterLogin;
	private Stopwatch _loginStopwatch = new();
	private List<string>? errorMessages;

	private class LoginModel
	{
		public string Email { get; set; } = string.Empty;
		public string Password { get; set; } = string.Empty;
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			await JS.InvokeVoidAsync("loadScriptAndTrigger", "assets/js/main.js", true);
			await JS.InvokeVoidAsync("loadScriptAndTrigger", "assets/js/popular.js", true);
			await JS.InvokeVoidAsync("loadScriptAndTrigger", "assets/js/bootstrap5.js", true);
			await JS.InvokeVoidAsync("loadScriptAndTrigger", "assets/js/auto-focus.js", true);
			await JS.InvokeVoidAsync("loadScriptAndTrigger", "assets/js/pages-auth.js", true);
			await JS.InvokeVoidAsync("loadScriptAndTrigger", "assets/js/toast.js", true);

		}
		await JS.InvokeVoidAsync("eval", "typeof initPagesAuth === 'function' && initPagesAuth();");
	}

	public async ValueTask DisposeAsync()
	{
		await JS.InvokeVoidAsync("eval", "window.destroyPagesAuth && window.destroyPagesAuth();");
	}

	private string GetResendLink()
	{
		var email = loginModel.Email ?? string.Empty;
		if (string.IsNullOrWhiteSpace(email))
		{
			return "/send-confirmation-email";
		}
		var encoded = Uri.EscapeDataString(email);
		return $"/send-confirmation-email?email={encoded}";
	}

	private async Task HandleLogin()
	{
		// Individual field validation
		bool emailMissing = string.IsNullOrWhiteSpace(loginModel.Email);
		bool passwordMissing = string.IsNullOrWhiteSpace(loginModel.Password);

		if (emailMissing && passwordMissing)
		{
			await JS.InvokeVoidAsync("showToast", "error", "Email and password are required.");
			return;
		}

		if (emailMissing)
		{
			await JS.InvokeVoidAsync("showToast", "error", "Email is required.");
			return;
		}

		if (passwordMissing)
		{
			await JS.InvokeVoidAsync("showToast", "error", "Password is required.");
			return;
		}

		// Email format validation
		var emailPattern = @"^[^@\s]+@[^@\s]+\.[^@\s]+$";
		if (!Regex.IsMatch(loginModel.Email, emailPattern))
		{
			await JS.InvokeVoidAsync("showToast", "error", "Please enter a valid email address.");
			return;
		}

		_loginStopwatch = Stopwatch.StartNew();
		Logger.LogInformation("[LOGIN {Elapsed}ms] Login initiated for {Email}",
			_loginStopwatch.ElapsedMilliseconds, loginModel.Email);

		isLoading = true;
		message = null;
		errorMessages = new();

		try
		{
			Logger.LogInformation("[LOGIN {Elapsed}ms] Sending login request",
				_loginStopwatch.ElapsedMilliseconds);

			var response = await Http.PostAsJsonAsync("/auth/login", loginModel);

			Logger.LogInformation("[LOGIN {Elapsed}ms] Login response received - Status: {StatusCode}",
				_loginStopwatch.ElapsedMilliseconds, response.StatusCode);

			ApiResponse<LoginResultDto>? apiResponse = null;
			try
			{
				apiResponse = await response.Content.ReadFromJsonAsync<ApiResponse<LoginResultDto>>();
				Logger.LogInformation("[LOGIN {Elapsed}ms] Response deserialized - Success: {Success}, RequiresTwoFactor: {RequiresTwoFactor}",
					_loginStopwatch.ElapsedMilliseconds, apiResponse?.Success, apiResponse?.Data?.RequiresTwoFactor);
			}
			catch (Exception ex)
			{
				Logger.LogError(ex, "[LOGIN {Elapsed}ms] Failed to deserialize response",
					_loginStopwatch.ElapsedMilliseconds);
				await JS.InvokeVoidAsync("showToast", "error", "Invalid response from server. Please try again.");
				isLoading = false;
				return;
			}

			if (response.IsSuccessStatusCode &&
				apiResponse?.Success == true &&
				apiResponse.Data is not null)
			{
				var loginResult = apiResponse.Data;

				// Check if 2FA is required
				if (loginResult.RequiresTwoFactor)
				{
					Logger.LogInformation("[LOGIN {Elapsed}ms] 2FA required - Type: {TwoFactorType}",
						_loginStopwatch.ElapsedMilliseconds, loginResult.TwoFactorType);

					// Store the 2FA session info for the verification page
					await AuthProvider.SetPendingTwoFactorAsync(
						loginModel.Email,
						loginResult.TwoFactorToken ?? string.Empty,
						loginResult.TwoFactorType ?? "Email");

					isLoading = false;
					Nav.NavigateTo("/two-factor-login");
					return;
				}

				// No 2FA required - proceed with normal login
				// Server has set HttpOnly cookies, but we also need to set the accessToken
				// as a client-accessible cookie since cross-origin cookies may not be readable
				Logger.LogInformation("[LOGIN {Elapsed}ms] Setting authentication from response token",
					_loginStopwatch.ElapsedMilliseconds);

				// Set the token client-side (this will store in cookie and update auth state)
				await AuthProvider.SetAuthenticationAsync(loginResult.AccessToken);

				Logger.LogInformation("[LOGIN {Elapsed}ms] Auth state set successfully",
					_loginStopwatch.ElapsedMilliseconds);
				
				// Wait for auth state to propagate fully
				await Task.Delay(150);
				
				// Hide login form spinner and show fullpage loading spinner
				isLoading = false;
				_isLoadingMenuAfterLogin = true;
				StateHasChanged();

				Logger.LogInformation("[LOGIN {Elapsed}ms] Loading navigation menu...",
					_loginStopwatch.ElapsedMilliseconds);

				// Load the navigation menu before navigating
				try
				{
					var menuLoaded = await NavService.LoadNavigationAsync(forceRefresh: true);
					Logger.LogInformation("[LOGIN {Elapsed}ms] Menu load result: {MenuLoaded}",
						_loginStopwatch.ElapsedMilliseconds, menuLoaded);
				}
				catch (Exception menuEx)
				{
					Logger.LogWarning(menuEx, "[LOGIN {Elapsed}ms] Menu load failed, continuing to home",
						_loginStopwatch.ElapsedMilliseconds);
				}

				_isLoadingMenuAfterLogin = false;
				StateHasChanged();

				// Navigate to home page
				Nav.NavigateTo("/", forceLoad: false);

				Logger.LogInformation("[LOGIN {Elapsed}ms] Navigation initiated",
					_loginStopwatch.ElapsedMilliseconds);
				return;
			}

			// Handle login failure
			if (apiResponse?.Errors is { Count: > 0 })
			{
				foreach (var error in apiResponse.Errors)
				{
					errorMessages!.Add(error);
				}
				message = string.Join(", ", errorMessages!);
			}
			else
			{
				message = apiResponse?.Message ?? "Login failed.";
			}
			
			await JS.InvokeVoidAsync("showToast", "error", message);
			isLoading = false;
		}
		catch (HttpRequestException httpEx)
		{
			Logger.LogError(httpEx, "[LOGIN {Elapsed}ms] HTTP error during login",
				_loginStopwatch.ElapsedMilliseconds);

			isLoading = false;
			message = "Unable to connect to the server. Please check your internet connection.";
			await JS.InvokeVoidAsync("showToast", "error", message);
		}
		catch (Exception ex)
		{
			Logger.LogError(ex, "[LOGIN {Elapsed}ms] Unexpected error during login",
				_loginStopwatch.ElapsedMilliseconds);

			isLoading = false;
			message = "An unexpected error occurred. Please try again.";
			await JS.InvokeVoidAsync("showToast", "error", message);
		}
	}
}
