@page "/change-password"
@using AuthManagement.Shared
@using AuthManagement.Services
@using AuthManagement.Models
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@attribute [Authorize]
@inject HttpClient Http
@inject JwtAuthenticationStateProvider AuthProvider
@inject IJSRuntime JSRuntime
@inject ILogger<ChangePassword> Logger
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject NavigationManager Nav


<style>
    .factorBackground{
        background: #7367f012;
    }
</style>

<div class="flex-grow-1 mt-3">
    <!-- Header -->
    <div class="row">
        <div class="col-md-12">


             <div class="card mb-6">
                        <div class="user-profile-header-banner">
                            <img src="assets/img/avatars/profile-banner.png" alt="Banner image" class="rounded-top">
                        </div>
                        <div class="user-profile-header d-flex flex-column flex-lg-row text-sm-start text-center mb-5">
                            <div class="flex-shrink-0 mt-n2 mx-sm-0 mx-auto">
                                <img src="assets/img/avatars/1.png" alt="user image" class="d-block h-auto ms-0 ms-sm-6 rounded user-profile-img">
                            </div>
                            <div class="flex-grow-1 mt-3 mt-lg-5">
                                <div class="d-flex align-items-md-end align-items-sm-start align-items-center justify-content-md-between justify-content-start mx-5 flex-md-row flex-column gap-4">
                                     @if (profile!=null){
        
                                    <div class="user-profile-info">
                                        <h4 class="mb-2 mt-lg-6">@profile.FirstName @profile.LastName</h4>
                                        <ul class="list-inline mb-0 d-flex align-items-center flex-wrap justify-content-sm-start justify-content-center gap-4 my-2">
                                            <li class="list-inline-item d-flex gap-2 align-items-center"><i class="icon-base ti tabler-mail icon-lg"></i><span class="fw-medium">@profile.Email</span></li>
                                            <li class="list-inline-item d-flex gap-2 align-items-center"><i class="icon-base ti tabler-user  icon-lg"></i><span class="fw-medium"> @profile.FirstName @profile.LastName</span></li>
                                        </ul>
                                    </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>


            <div class="nav-align-top">
                <ul class="nav nav-pills flex-column flex-md-row mb-6 gap-md-0 gap-2">
                    <li class="nav-item">
                        <a class="nav-link" href="/profile"><i class="icon-base ti tabler-users icon-sm me-1_5"></i> Account</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="javascript:void(0);"><i class="icon-base ti tabler-lock icon-sm me-1_5"></i> Security</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/BillingPlan"><i class="icon-base ti tabler-bookmark icon-sm me-1_5"></i> Billing & Plans</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Notification"><i class="icon-base ti tabler-bell icon-sm me-1_5"></i> Notifications</a>
                    </li>
                </ul>
            </div>
            <!-- Change Password -->
            <div class="card mb-6">
                <h5 class="card-header">Change Password</h5>
                <div class="card-body pt-1">
                    <EditForm Model="model"
                              OnValidSubmit="HandleSubmit"
                              id="formChangePassword">
                        <DataAnnotationsValidator />

                        <div class="row mb-sm-6 mb-2">
                            <div class="col-md-6 form-password-toggle form-control-validation">
                                <label class="form-label" for="currentPassword">Current Password <span class="text-danger">*</span></label>
                                <div class="input-group input-group-merge">
                                    <InputText type="@(showCurrentPassword ? "text" : "password")"
                                               @bind-Value="model.CurrentPassword"
                                               data-input-type="password"
                                               class="form-control"
                                               id="currentPassword"
                                               placeholder="············" />
                                    <span class="input-group-text cursor-pointer" @onclick="() => showCurrentPassword = !showCurrentPassword">
                                        <i class="ti @(showCurrentPassword ? "tabler-eye" : "tabler-eye-off")"></i>
                                    </span>
                                </div>
                                <ValidationMessage For="@(() => model.CurrentPassword)" class="text-danger" />
                            </div>
                        </div>
                        <div class="row gy-sm-6 gy-2 mb-sm-0 mb-2">
                            <div class="mb-6 col-md-6 form-password-toggle form-control-validation">
                                <label class="form-label" for="newPassword">New Password <span class="text-danger">*</span></label>
                                <div class="input-group input-group-merge">
                                    <InputText type="@(showNewPassword ? "text" : "password")"
                                               @bind-Value="model.NewPassword"
                                               data-input-type="password"
                                               class="form-control"
                                               id="newPassword"
                                               placeholder="············" />
                                    <span class="input-group-text cursor-pointer" @onclick="() => showNewPassword = !showNewPassword">
                                        <i class="ti @(showNewPassword ? "tabler-eye" : "tabler-eye-off")"></i>
                                    </span>
                                </div>
                                <ValidationMessage For="@(() => model.NewPassword)" class="text-danger" />
                            </div>

                            <div class="mb-6 col-md-6 form-password-toggle form-control-validation">
                                <label class="form-label" for="confirmPassword">Confirm New Password <span class="text-danger">*</span></label>
                                <div class="input-group input-group-merge">
                                    <InputText type="@(showConfirmPassword ? "text" : "password")"
                                               @bind-Value="model.ConfirmNewPassword"
                                               data-input-type="password"
                                               class="form-control"
                                               id="confirmPassword"
                                               placeholder="············" />
                                    <span class="input-group-text cursor-pointer" @onclick="() => showConfirmPassword = !showConfirmPassword">
                                        <i class="ti @(showConfirmPassword ? "tabler-eye" : "tabler-eye-off")"></i>
                                    </span>
                                </div>
                                <ValidationMessage For="@(() => model.ConfirmNewPassword)" class="text-danger" />
                            </div>
                        </div>
                        <h6 class="text-body">Password Requirements:</h6>
                        <ul class="ps-4 mb-0">
                            @* <li class="mb-4">Minimum 6 characters long - the more, the better</li>
                            <li class="mb-4">At least one lowercase character</li>
                            <li>At least one number, symbol, or whitespace character</li> *@
                            <li>Use at least 6 characters with uppercase, lowercase, number, and special character.</li>
                        </ul>
                        <div class="mt-6 d-flex align-items-center gap-5">
                            @* <button type="submit" class="btn btn-primary me-3">Save changes</button> *@
                            <button class="btn btn-primary d-flex" type="submit" disabled="@isLoading">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Saving Password...</span>
                                }
                                else
                                {
                                    <span>Save changes</span>
                                }
                            </button>
                            <button type="reset" class="btn btn-label-secondary">Reset</button>
                        </div>
                    </EditForm>
                </div>
            </div>
            <!--/ Change Password -->
         @* Two Factor *@
        

             <div class="card p-5">
                <div class="twofactor-header text-start mb-4">
                    <div class="d-flex align-items-center gap-2">
                    <h5 class="mb-0">Two-Factor Authentication</h5>
                     @if (twoFactorType == "Authenticator")
                                {
                                    <span class="badge bg-success">
                                        <i class="bi-phone me-1"></i>Authenticator App
                                    </span>
                                }
                                else if (twoFactorType == "Email")
                                {
                                    <span class="badge bg-info">
                                        <i class="bi-envelope me-1"></i>Email OTP
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">Disabled</span>
                                }
                                </div>
                    <div class="p-0">
                        <p class="text-start text-muted mb-0">
                            Two-factor authentication adds an extra layer of security to your account by requiring
                            a verification code in addition to your password when signing in.
                        </p>
                    </div>
                </div>

                <hr class="my-2" />

                @if (isLoading)
                {
                    <LoadingSpinner FullPage="true" />
                }
                else
                {
                    <div class="twofactor-content">
                        
                       
                        <div class="options-section mt-3">
                            <h6 class="mb-3">Authentication Method</h6>

                            <!-- Disable 2FA -->
                            <div class="option-card p-3 mb-3 rounded border @(twoFactorType == "None" ? "border-primary factorBackground" : "")">
                                <div class="form-check">
                                  
                                    <label class="form-check-label w-100" for="disable2fa">
                                        <div class="d-flex align-items-center mb-2 ">
                                              <input class="form-check-input" type="radio" name="twoFactorOptions"
                                           id="disable2fa"
                                           checked="@(twoFactorType == "None")"
                                           disabled="@isBusy"
                                           @onclick="DisableTwoFactor" />
                                            <i class="ti tabler-lock-open-2 fs-4 text-danger me-2 ms-2" style="font-size: 33px !important;"></i>
                                            <strong>Disabled</strong>
                                        </div>
                                        <p class="text-muted mb-0 small">Sign in with just your password (not recommended)</p>
                                    </label>
                                </div>
                            </div>

                            <!-- Email OTP -->
                            <div class="option-card p-3 mb-3 rounded border @(twoFactorType == "Email" ? "border-primary factorBackground" : "")">
                                <div class="form-check">
                                  
                                    <label class="form-check-label w-100" for="enableEmail2fa">
                                        <div class="d-flex align-items-center mb-2">
                                              <input class="form-check-input" type="radio" name="twoFactorOptions"
                                           id="enableEmail2fa"
                                           checked="@(twoFactorType == "Email")"
                                           disabled="@isBusy"
                                           @onclick="EnableEmailTwoFactor" />
                                            <i class="ti tabler-mail-check fs-4 text-info me-2 ms-2" style="font-size: 33px !important;"></i>
                                            <strong>Email Verification</strong>
                                        </div>
                                        <p class="text-muted mb-0 small">Receive a verification code via email</p>
                                    </label>
                                </div>
                            </div>

                            <!-- Authenticator App -->
                            <div class="option-card p-3 mb-3 rounded border @(twoFactorType == "Authenticator" ? "border-primary factorBackground" : "")">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="form-check flex-grow-1">
                                      
                                        <label class="form-check-label w-100" for="enableAuthenticator">
                                            <div class="d-flex align-items-center mb-2">
                                                  <input class="form-check-input" type="radio" name="twoFactorOptions"
                                               id="enableAuthenticator"
                                               checked="@(twoFactorType == "Authenticator")"
                                               disabled="@isBusy"
                                               @onclick="NavigateToAuthenticatorSetup" />
                                                <i class="ti tabler-device-mobile-check fs-4 text-success me-2 ms-2" style="font-size: 33px !important;"></i>
                                                <strong>Authenticator App</strong>
                                                <span class="badge bg-success ms-2">Recommended</span>
                                            </div>
                                            <p class="text-muted mb-0 small">
                                                Use Google Authenticator, Microsoft Authenticator, or similar apps
                                            </p>
                                        </label>
                                    </div>
                                    @* @if (twoFactorType != "Authenticator")
                                {
                                    <button class="btn btn-sm btn-outline-primary ms-2" 
                                            @onclick="NavigateToAuthenticatorSetup" 
                                            disabled="@isBusy">
                                        Set Up
                                    </button>
                                } *@
                                </div>
                            </div>
                        </div>

                        @if (isBusy)
                        {
                            <LoadingSpinner FullPage="true" />

                        }
                    </div>
                }
            </div>



        </div>
    </div>
</div>

@code {

    private ProfileDto? profile;
    private string? message;
    private bool isLoading = true;
    private bool isBusy;
    private string twoFactorType = "None";

    private ChangePasswordModel model = new();
    private bool showCurrentPassword;
    private bool showNewPassword;
    private bool showConfirmPassword;

    
     protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("loadScriptAndTrigger", "assets/js/toast.js", true);
        }
    }

   
    private async Task DisableTwoFactor()
    {
        if (isBusy || twoFactorType == "None") return;

        isBusy = true;
        message = null;

        try
        {
            var token = await AuthProvider.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            // If authenticator is enabled, disable it
            if (twoFactorType == "Authenticator")
            {
                var authResponse = await Http.PostAsync("/auth/authenticator/disable", null);
                if (!authResponse.IsSuccessStatusCode)
                {
                    var result = await authResponse.Content.ReadFromJsonAsync<ApiResponse<object>>();
                    await JS.InvokeVoidAsync("showToast", "error", result?.Message ?? "Failed to disable authenticator.");
                    return;
                }
            }
            else
            {
                // Disable email 2FA
                var response = await Http.PostAsync("/auth/2fa/disable", null);
                if (!response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<ApiResponse<object>>();
                    await JS.InvokeVoidAsync("showToast", "error", result?.Message ?? "Failed to disable two-factor.");
                    return;
                }
            }

            twoFactorType = "None";
            await JS.InvokeVoidAsync("showToast", "success", "Two-factor authentication has been disabled.");
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task EnableEmailTwoFactor()
    {
        if (isBusy || twoFactorType == "Email") return;

        isBusy = true;
        message = null;

        try
        {
            var token = await AuthProvider.GetTokenAsync();
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            // If authenticator is currently enabled, disable it first
            if (twoFactorType == "Authenticator")
            {
                var disableResponse = await Http.PostAsync("/auth/authenticator/disable", null);
                if (!disableResponse.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("showToast", "error", "Failed to switch authentication method.");
                    return;
                }
            }

            // Enable email 2FA
            var response = await Http.PostAsync("/auth/2fa/enable", null);
            if (response.IsSuccessStatusCode)
            {
                twoFactorType = "Email";
                await JS.InvokeVoidAsync("showToast", "success", "Email verification has been enabled.");
            }
            else
            {
                var result = await response.Content.ReadFromJsonAsync<ApiResponse<object>>();
                await JS.InvokeVoidAsync("showToast", "error", result?.Message ?? "Failed to enable email verification.");
            }
        }
        finally
        {
            isBusy = false;
        }
    }

    private void NavigateToAuthenticatorSetup()
    {
        Nav.NavigateTo("/authenticator-setup");
    }

    protected override async Task OnInitializedAsync()
    {
        var token = await AuthProvider.GetTokenAsync();

        // If token missing → redirect
        if (string.IsNullOrEmpty(token))
        {
            Nav.NavigateTo("/login");
            return;
        }

        Http.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", token);

        try
        {
            // Call API → /auth/profile
            var response = await Http.GetAsync("/auth/profile");

            if (response.IsSuccessStatusCode)
            {
                var apiResponse =
                    await response.Content.ReadFromJsonAsync<ApiResponse<ProfileDto>>();

                if (apiResponse?.Success == true && apiResponse.Data is not null)
                {
                    // Save profile
                    profile = apiResponse.Data;

                    // Save 2FA type
                    twoFactorType = apiResponse.Data.TwoFactorType;
                }
                else
                {
                    message = apiResponse?.Message ?? "Failed to load profile.";
                }
            }
            else
            {
                message = "Failed to load profile.";
            }
        }
        finally
        {
            isLoading = false;
        }
    }


    private class ChangePasswordModel
    {
        [Required(ErrorMessage = "Current password is required")]
        public string CurrentPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "New password is required")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Please confirm your new password")]
        [Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match")]
        public string ConfirmNewPassword { get; set; } = string.Empty;
    }

    private async Task HandleSubmit()
    {
        // Issue #9: Check if new password is same as current password
        if (model.NewPassword == model.CurrentPassword)
        {
            await JSRuntime.InvokeVoidAsync("showToast", "error", "New password must be different from current password.");
            return;
        }

        isLoading = true;

        var token = await AuthProvider.GetTokenAsync();
        if (!string.IsNullOrEmpty(token))
        {
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
        }

        try
        {
            var response = await Http.PostAsJsonAsync("/auth/change-password", model);
            
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("showToast", "success", "Password changed successfully!");
                model = new ChangePasswordModel();
                
                await Task.Delay(1000);
                Navigation.NavigateTo("/");
            }
            else
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<ApiResponse<object>>();
                var errorMessage = apiResponse?.Message ?? "Failed to change password";
                
                if (apiResponse?.Errors?.Count > 0)
                {
                    errorMessage = string.Join(", ", apiResponse.Errors);
                }
                
                await JSRuntime.InvokeVoidAsync("showToast", "error", errorMessage);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error changing password");
            await JSRuntime.InvokeVoidAsync("showToast", "error", "An error occurred. Please try again.");
        }
        finally
        {
            isLoading = false;
        }
    }
}
