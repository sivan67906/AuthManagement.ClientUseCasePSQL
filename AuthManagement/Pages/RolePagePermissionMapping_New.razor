@page "/rolepagepermissionmappingnew"
@using AuthManagement.Models
@using AuthManagement.Services
@using AuthManagement.Shared
@inject RBACService RBACService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject ILogger<RolePagePermissionMapping> Logger
@attribute [Authorize]

<PageTitle>Role Page Permission Mapping</PageTitle>

<style>
    /* Permission Badges */
    .permission-badges-container {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-items: center;
    }

    .permission-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
        padding: 5px 10px;
        border-radius: 6px;
        min-width: 28px;
        color: white;
        text-transform: uppercase;
    }

    .badge-view { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .badge-create { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .badge-edit { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .badge-delete { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .badge-default { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }

    /* Table Styles */
    .table-container {
        overflow-x: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    .data-table th {
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }

    .data-table tbody tr {
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.2s;
    }

    .data-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .data-table td {
        padding: 12px 16px;
        color: #495057;
        font-size: 14px;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-action {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
    }

    .btn-edit {
        background: #3b82f6;
        color: white;
    }

    .btn-edit:hover {
        background: #2563eb;
    }

    .btn-delete {
        background: #ef4444;
        color: white;
    }

    .btn-delete:hover {
        background: #dc2626;
    }

    .btn-create {
        background: #10b981;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
    }

    .btn-create:hover {
        background: #059669;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 20px 0;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="container-fluid">
    <div class="page-header">
        <div>
            <h3>Role Page Permission Mapping</h3>
            <p class="text-muted">Manage permissions for each role and page combination</p>
        </div>
        <button class="btn-create" @onclick="OpenCreateDialog">
            <i class="bi bi-plus-circle me-2"></i>Create Mapping
        </button>
    </div>

    @if (_isLoading)
    {
        <div class="loading-overlay">
            <div class="spinner"></div>
        </div>
    }

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Department</th>
                    <th>Role</th>
                    <th>Page</th>
                    <th>Permissions</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (_groupedMappings != null && _groupedMappings.Any())
                {
                    @foreach (var mapping in _groupedMappings)
                    {
                        <tr>
                            <td>@(mapping.DepartmentName ?? "System-wide")</td>
                            <td>@mapping.RoleName</td>
                            <td>
                                <div>
                                    <div style="font-weight: 600;">@mapping.PageName</div>
                                    <div style="font-size: 12px; color: #6b7280;">@mapping.PageUrl</div>
                                </div>
                            </td>
                            <td>
                                <div class="permission-badges-container">
                                    @foreach (var perm in mapping.Permissions.OrderBy(p => p.PermissionName))
                                    {
                                        <span class="permission-badge @GetBadgeClass(perm.PermissionName)" 
                                              title="@perm.PermissionName">
                                            @GetPermissionCode(perm.PermissionName)
                                        </span>
                                    }
                                </div>
                            </td>
                            <td>@mapping.CreatedAt.ToString("MMM dd, yyyy")</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-edit" 
                                            @onclick="() => OpenEditDialog(mapping)">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn-action btn-delete" 
                                            @onclick="() => DeleteGroupedMapping(mapping)">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else if (!_isLoading)
                {
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                            No mappings found. Click "Create Mapping" to add one.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@* Form Dialog Component *@
<RolePagePermissionMappingFormDialog 
    @ref="_formDialog"
    OnSave="HandleSave"
    OnCancel="HandleCancel" />

@code {
    private List<RolePagePermissionGroupDto> _groupedMappings = new();
    private RolePagePermissionMappingFormDialog? _formDialog;
    private bool _isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadGroupedMappings();
    }

    private async Task LoadGroupedMappings()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            var response = await RBACService.GetGroupedRolePagePermissionsAsync();
            if (response.Success && response.Data != null)
            {
                _groupedMappings = response.Data;
            }
            else
            {
                await ShowToast("error", response.Message ?? "Failed to load mappings");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading grouped mappings");
            await ShowToast("error", "An error occurred while loading mappings");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void OpenCreateDialog()
    {
        _formDialog?.Open(null);
    }

    private void OpenEditDialog(RolePagePermissionGroupDto mapping)
    {
        _formDialog?.Open(mapping);
    }

    private async Task HandleSave()
    {
        await LoadGroupedMappings();
    }

    private void HandleCancel()
    {
        // Dialog closed without saving
    }

    private async Task DeleteGroupedMapping(RolePagePermissionGroupDto mapping)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Are you sure you want to delete all permissions for {mapping.RoleName} on {mapping.PageName}?");

        if (!confirmed) return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            // Delete each permission in the group
            foreach (var perm in mapping.Permissions)
            {
                var response = await RBACService.DeleteRolePagePermissionMappingAsync(perm.Id);
                
                if (!response.Success)
                {
                    // Check if it's a View permission error
                    if (response.Message != null && response.Message.Contains("Cannot delete View"))
                    {
                        await ShowToast("error", response.Message);
                        await LoadGroupedMappings();
                        return;
                    }
                }
            }

            await ShowToast("success", "Permissions deleted successfully");
            await LoadGroupedMappings();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting permissions");
            await ShowToast("error", "An error occurred while deleting permissions");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string GetBadgeClass(string permissionName)
    {
        return permissionName.ToLower() switch
        {
            "view" => "badge-view",
            "create" => "badge-create",
            "edit" => "badge-edit",
            "delete" => "badge-delete",
            _ => "badge-default"
        };
    }

    private string GetPermissionCode(string permissionName)
    {
        // Get first letter or custom code
        if (string.IsNullOrEmpty(permissionName)) return "?";
        
        return permissionName.ToLower() switch
        {
            "view" => "V",
            "create" => "C",
            "edit" => "E",
            "delete" => "D",
            _ => permissionName[0].ToString().ToUpper() // First letter for other permissions
        };
    }

    private async Task ShowToast(string type, string message)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("showToast", type, message);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error showing toast");
        }
    }
}
