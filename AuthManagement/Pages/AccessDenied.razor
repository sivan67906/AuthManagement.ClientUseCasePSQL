@page "/access-denied"
@using Microsoft.AspNetCore.Components.Authorization
@using AuthManagement.Services
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Access Denied</PageTitle>

<style>
    .access-denied-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
    }

    .access-denied-card {
        background: white;
        border-radius: 20px;
        padding: 50px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 600px;
        width: 100%;
        text-align: center;
    }

    .access-denied-icon {
        width: 120px;
        height: 120px;
        margin: 0 auto 30px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }

    .access-denied-icon i {
        font-size: 60px;
        color: white;
    }

    .access-denied-title {
        font-size: 32px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 15px;
    }

    .access-denied-message {
        font-size: 18px;
        color: #718096;
        margin-bottom: 10px;
        line-height: 1.6;
    }

    .access-denied-details {
        background: #f7fafc;
        border-radius: 10px;
        padding: 20px;
        margin: 25px 0;
        text-align: left;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 600;
        color: #4a5568;
    }

    .detail-value {
        color: #718096;
        text-align: right;
        word-break: break-all;
    }

    .btn-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
    }

    .btn-custom {
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 16px;
    }

    .btn-primary-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary-custom {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }

    .btn-secondary-custom:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.2);
    }

    .help-text {
        font-size: 14px;
        color: #a0aec0;
        margin-top: 20px;
    }
</style>

<div class="access-denied-wrapper">
    <div class="access-denied-card">
        <div class="access-denied-icon">
            <i class="bx bx-lock-alt"></i>
        </div>
        
        <h1 class="access-denied-title">Access Denied</h1>
        
        <p class="access-denied-message">
            You don't have permission to access this page.
        </p>

        @if (isAuthenticated)
        {
            <div class="access-denied-details">
                <div class="detail-row">
                    <span class="detail-label">Your Email:</span>
                    <span class="detail-value">@userEmail</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Your Roles:</span>
                    <span class="detail-value">@string.Join(", ", userRoles)</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Requested Page:</span>
                    <span class="detail-value">@requestedPage</span>
                </div>
            </div>

            <p class="access-denied-message" style="font-size: 16px;">
                This page is restricted to users with specific role permissions. 
                Contact your administrator if you believe you should have access.
            </p>
        }
        else
        {
            <p class="access-denied-message" style="font-size: 16px;">
                You need to be logged in to access this page.
            </p>
        }

        <div class="btn-group">
            @if (isAuthenticated)
            {
                <button class="btn-custom btn-secondary-custom" @onclick="GoBack">
                    <i class="bx bx-arrow-back"></i> Go Back
                </button>
                <a href="/dashboard" class="btn-custom btn-primary-custom">
                    <i class="bx bx-home"></i> Go to Dashboard
                </a>
            }
            else
            {
                <a href="/login" class="btn-custom btn-primary-custom">
                    <i class="bx bx-log-in"></i> Login
                </a>
            }
        </div>

        <p class="help-text">
            <i class="bx bx-info-circle"></i> 
            If you continue to experience issues, please contact support.
        </p>
    </div>
</div>

@code {
    private bool isAuthenticated = false;
    private string userEmail = "Not logged in";
    private List<string> userRoles = new();
    private string requestedPage = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        isAuthenticated = user?.Identity?.IsAuthenticated ?? false;

        if (isAuthenticated)
        {
            userEmail = user!.FindFirst("email")?.Value ?? "Unknown";
            userRoles = user.Claims
                .Where(c => c.Type == "role")
                .Select(c => c.Value)
                .ToList();
        }

        // Get the page they tried to access from navigation history
        requestedPage = await JSRuntime.InvokeAsync<string>("eval", "document.referrer") ?? "Unknown";
        if (!string.IsNullOrEmpty(requestedPage))
        {
            try
            {
                var uri = new Uri(requestedPage);
                requestedPage = uri.LocalPath;
            }
            catch
            {
                requestedPage = "Unknown";
            }
        }
    }

    private async Task GoBack()
    {
        await JSRuntime.InvokeVoidAsync("history.back");
    }
}
